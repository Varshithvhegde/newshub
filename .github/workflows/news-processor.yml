name: News Processor - Automated News Fetching

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      force_run:
        description: 'Force run even if already running'
        required: false
        default: 'false'
        type: boolean

jobs:
  fetch-and-process-news:
    name: Fetch and Process News Articles
    runs-on: ubuntu-latest
    environment: NEWSAPI_KEY
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
          
      - name: Install dependencies
        run: |
          cd backend
          npm ci
          
      - name: Setup environment variables
        run: |
          cd backend
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "NEWSAPI_KEY=${{ secrets.NEWSAPI_KEY }}" >> .env
          echo "PORT=3001" >> .env
          echo "NODE_ENV=production" >> .env
          
      - name: Debug environment variables
        run: |
          echo "🔍 Debugging environment variables..."
          echo "REDIS_URL exists: ${{ secrets.REDIS_URL != '' }}"
          echo "GEMINI_API_KEY exists: ${{ secrets.GEMINI_API_KEY != '' }}"
          echo "NEWSAPI_KEY exists: ${{ secrets.NEWSAPI_KEY != '' }}"
          echo "Environment: ${{ github.ref_name }}"
          
      - name: Test Redis connection
        run: |
          cd backend
          echo "🔍 Testing Redis connection..."
          node -e "
            const { createClient } = require('redis');
            const client = createClient({ url: process.env.REDIS_URL });
            
            async function testRedis() {
              try {
                console.log('🔗 Attempting to connect to Redis...');
                console.log('📍 Redis URL:', process.env.REDIS_URL ? 'Set' : 'Not set');
                await client.connect();
                console.log('✅ Redis connection successful!');
                
                // Test basic operations
                await client.set('test:workflow', 'connected');
                const testValue = await client.get('test:workflow');
                console.log('✅ Basic Redis operations working');
                
                // Get server info
                const info = await client.info('server');
                console.log('📊 Redis server info:', info.split('\\n')[0]);
                
                // Get database size (using SCAN instead of dbsize)
                let keyCount = 0;
                for await (const key of client.scanIterator()) {
                  keyCount++;
                  if (keyCount > 100) break; // Limit scan for performance
                }
                console.log('📊 Approximate keys in Redis:', keyCount);
                
                // Clean up test key
                await client.del('test:workflow');
                await client.disconnect();
                console.log('🔌 Redis connection closed');
              } catch (error) {
                console.error('❌ Redis connection failed:', error.message);
                console.error('🔍 Error details:', error);
                process.exit(1);
              }
            }
            
            testRedis();
          "
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          
      - name: Run news processor
        run: |
          cd backend
          node addNews.js
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          NODE_ENV: production
          
      - name: Log completion
        run: |
          echo "✅ News processing completed at $(date)"
          echo "📰 Articles fetched and processed successfully"
          
  # Optional: Add a job to monitor the process
  monitor-process:
    name: Monitor News Processing
    runs-on: ubuntu-latest
    needs: fetch-and-process-news
    if: always()
    environment: NEWSAPI_KEY
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
          
      - name: Install dependencies
        run: |
          cd backend
          npm ci
          
      - name: Check Redis connection and stats
        run: |
          cd backend
          echo "🔍 Checking Redis connection and cache statistics..."
          node -e "
            const { createClient } = require('redis');
            const client = createClient({ url: process.env.REDIS_URL });
            
            async function checkRedis() {
              try {
                await client.connect();
                console.log('✅ Redis connection successful');
                
                // Get memory info
                const info = await client.info('memory');
                const memoryLine = info.split('\\n').find(line => line.startsWith('used_memory_human'));
                console.log('💾 Memory usage:', memoryLine);
                
                // Count keys using SCAN
                let keyCount = 0;
                for await (const key of client.scanIterator()) {
                  keyCount++;
                  if (keyCount > 1000) break; // Limit scan for performance
                }
                console.log('📊 Approximate total keys in Redis:', keyCount);
                
                // Get server info
                const serverInfo = await client.info('server');
                console.log('📊 Redis server info:', serverInfo.split('\\n')[0]);
                
                await client.disconnect();
              } catch (error) {
                console.error('❌ Redis connection failed:', error.message);
                console.error('🔍 Error details:', error);
                process.exit(1);
              }
            }
            
            checkRedis();
          "
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          
      - name: Generate processing report
        run: |
          echo "📋 News Processing Report" >> $GITHUB_STEP_SUMMARY
          echo "=========================" >> $GITHUB_STEP_SUMMARY
          echo "- **Job Status**: ${{ needs.fetch-and-process-news.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.fetch-and-process-news.result }}" == "success" ]; then
            echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi 